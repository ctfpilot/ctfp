# CTF Pilot's Kubernetes Cluster on Hetzner Cloud

> [!IMPORTANT]
> You are leaving the automated CTF Pilot setup and entering a more advanced manual setup.  
> This requires knowledge of Kubernetes, Terraform/OpenTofu, and cloud infrastructure management.  
> If you are not comfortable with these technologies, it is recommended to use the automated setup provided by CTF Pilot.  
> Learn more about the automated setup in the [CTF Pilot's CTF Platform main README](../README.md).

This setup uses [Terraform](https://www.terraform.io/) / [OpenTofu](https://opentofu.org) to create and manage a Kubernetes cluster on [Hetzner Cloud](https://www.hetzner.com/cloud), using the [kube-hetzner](https://github.com/kube-hetzner/terraform-hcloud-kube-hetzner). The cluster is configured to use [Cloudflare](https://www.cloudflare.com/) for DNS management.

## Pre-requisites

The following software needs to be installed on your local machine:

- [Terraform](https://www.terraform.io/downloads.html) / [OpenTofu](https://opentofu.org)
- [Packer](https://developer.hashicorp.com/packer/tutorials/docker-get-started/get-started-install-cli#installing-packer) (For initial setup of snapshots for the servers)
- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) (For interacting with the Kubernetes cluster)
- [hcloud cli tool](https://github.com/hetznercloud/cli) (For interacting with the Hetzner Cloud API)
- SSH client (For connecting to the servers)

The following services are required, in order to deploy the Kubernetes cluster:

- [Hetzner Cloud](https://www.hetzner.com/cloud) account
- [Hetzner Cloud API Token](https://console.hetzner.cloud/projects) (For authenticating with the Hetzner Cloud API)
- [Cloudflare](https://www.cloudflare.com/) account
- [Cloudflare API Token](https://dash.cloudflare.com/profile/api-tokens) (For authenticating with the Cloudflare API)
- [Cloudflare controlled domain](https://dash.cloudflare.com/) (For allowing the system to allocate a domain for the Kubernetes cluster)

### SSH keys

In order to connect to the servers, you need to have an SSH key pair. The keys path needs to be set in the tfvars file.

*The SSH key should be ssh-ed25519 or rsa-sha2-512 (for easy use, passphrase-less)*  
`ssh-keygen -t ed25519`

*Can be generated by running: `./keys/create.sh` and copying the keys into tfvars.*

## Setup

### Image creation (Done once)

> [!TIP]
>
> Image creation is only required once, to create the snapshots for the servers.  
> If you want to update the the snapshots, this step can be repeated.

In order to create the cluster, we need to create snapshots of the servers that will be used in the cluster. This is done by running the following command (say yes, to build snapshots using packer):

```bash	
tmp_script=$(mktemp) && curl -sSL -o "${tmp_script}" https://raw.githubusercontent.com/kube-hetzner/terraform-hcloud-kube-hetzner/master/scripts/create.sh && chmod +x "${tmp_script}" && "${tmp_script}" && rm "${tmp_script}"
```

**Note:** This will create a snapshot of the server, which will be used as the base image for the Kubernetes cluster, as well as ensuring local software is installed.  
*The software has been provided by the [kube-hetzner](https://github.com/kube-hetzner/terraform-hcloud-kube-hetzner) project.*

### Cluster creation

Copy the `tfvars/template.tfvars` file to `tfvars/data.tfvars` and edit the file with your own values.  
The [`tfvars/template.tfvars`](tfvars/template.tfvars) file contains further information on each variable.

For deeper customization, you can edit the `kube.tf` file to change the cluster configuration.  
This file is a configured version of the [kube-hetzner `kube.tf`](https://github.com/kube-hetzner/terraform-hcloud-kube-hetzner).

> [!IMPORTANT]
> Make sure you generate the backend configuration file before creating the cluster.  
> See the [backend generation instructions](../backend/README.md) for more information.
>
> You will also need to set the following environment variables for authentication to the S3 backend:
> - `AWS_ACCESS_KEY_ID`
> - `AWS_SECRET_ACCESS_KEY`
>
> See [OpenTofub backend S3 configuration](https://opentofu.org/docs/language/settings/backends/s3/) for more information.

Run the following command to create the Kubernetes cluster:

```bash
tofu init -backend-config=../backend/generated/cluster.hcl
tofu apply --var-file tfvars/data.tfvars
```

The creation process may take several minutes to complete.

If you expereience issues, it may be one or multiple of the following issues:

- The type of servers in Hetzner may not be available. Check to see if they are available in your selected datacenter.
- Your firewall may also be blocking ssh requests to the servers, which causes a deadlock in the configuration of the servers.

For more detailed troubleshooting, refer to the [kube-hetzner documentation](https://github.com/kube-hetzner/terraform-hcloud-kube-hetzner).

During creation, Cloudflare DNS records will be created for the cluster.

### Cluster deletion

To delete the Kubernetes cluster, run the following command:

```bash
tofu destroy --var-file tfvars/template.tfvars
```

## Accessing the cluster

To access the Kubernetes cluster, you need to set up the `kubeconfig` file. This can be done by running the following command:

```bash
tofu output --raw kubeconfig > ./kube-config.yml
```
